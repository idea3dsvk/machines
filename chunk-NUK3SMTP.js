import{e as U}from"./chunk-X3AAU7TY.js";import{$b as D,Ea as v,I as f,L as k,P as g,Zb as w,_b as s,ba as y,i as h,j as l,o as b,v as d}from"./chunk-2YHSOBKZ.js";var c=class c{constructor(){this.apiService=g(w);this.supabaseService=g(D);this.router=g(U);this.ngZone=g(v);this.currentUser=y(null);this.initializeAuth(),this.setupAuthListener()}async initializeAuth(){if(s.enableMockData){let e=localStorage.getItem("currentUser");if(e)try{this.currentUser.set(JSON.parse(e))}catch(r){console.error("Error parsing stored user:",r),this.clearAuthData()}return}try{let{data:{session:e}}=await this.supabaseService.auth.getSession();e?.user&&await this.loadUserProfile(e.user.id)}catch(e){console.error("Error initializing auth:",e)}}setupAuthListener(){s.enableMockData||this.supabaseService.auth.onAuthStateChange(async(e,r)=>{e==="SIGNED_IN"&&r?.user?await this.loadUserProfile(r.user.id):e==="SIGNED_OUT"&&this.currentUser.set(null)})}async loadUserProfile(e){try{let{data:r,error:t}=await this.supabaseService.db.from("users").select("*").eq("id",e).single();if(t)throw t;if(r){let o={id:r.id,email:r.email,role:r.role};this.currentUser.set(o),localStorage.setItem("currentUser",JSON.stringify(o))}}catch(r){console.error("Error loading user profile:",r)}}login(e,r){if(console.log("login() called with role:",e),console.log("enableMockData:",s.enableMockData),s.enableMockData)return console.log("Using mock login"),this.mockLogin(e);let t=`${e}@example.com`,o=r||"password123";console.log("Attempting Supabase login with email:",t);let p=fetch(`${s.supabase.url}/auth/v1/token?grant_type=password`,{method:"POST",headers:{"Content-Type":"application/json",apikey:s.supabase.anonKey},body:JSON.stringify({email:t,password:o})}).then(async n=>{console.log("Supabase API response:",n.status);let a=await n.json();if(!n.ok)throw new Error(a.error_description||a.msg||"Login failed");console.log("Login successful, user:",a.user),console.log("Storing tokens in localStorage..."),localStorage.setItem("supabase.auth.token",JSON.stringify({access_token:a.access_token,refresh_token:a.refresh_token,expires_at:a.expires_at})),console.log("Loading user profile for ID:",a.user.id);try{let i=await(await fetch(`${s.supabase.url}/rest/v1/users?id=eq.${a.user.id}`,{headers:{apikey:s.supabase.anonKey,Authorization:`Bearer ${a.access_token}`}})).json();if(console.log("Profile response:",i),i&&i.length>0){let u=i[0],m={id:u.id,email:u.email,role:u.role};this.currentUser.set(m),localStorage.setItem("currentUser",JSON.stringify(m)),console.log("User profile loaded:",m)}else{console.warn("No profile found, using data from auth");let u={id:a.user.id,email:a.user.email,role:"admin"};this.currentUser.set(u),localStorage.setItem("currentUser",JSON.stringify(u))}}catch(S){console.error("Error loading user profile:",S);let i={id:a.user.id,email:a.user.email,role:"admin"};this.currentUser.set(i),localStorage.setItem("currentUser",JSON.stringify(i))}return!0}).catch(n=>{throw console.error("Login error:",n),n});return h(p).pipe(f(n=>{n&&(console.log("Login successful, navigating to dashboard..."),console.log("Current user:",this.currentUser()),this.ngZone.run(()=>{this.router.navigate(["/dashboard"]).then(()=>{console.log("Navigation completed")})}))}),d(n=>(console.error("Login catchError:",n),this.mockLogin(e))))}signUp(e,r,t){return s.enableMockData?l(!1):h(this.supabaseService.auth.signUp({email:e,password:r})).pipe(f(async({data:o,error:p})=>{if(p)throw p;o.user&&(await this.supabaseService.db.from("users").insert({id:o.user.id,email:o.user.email,role:t}),await this.loadUserProfile(o.user.id))}),b(({error:o})=>!o),d(o=>(console.error("Sign up error:",o),l(!1))))}mockLogin(e){let r={id:e==="admin"?"1":"2",email:`${e}@example.com`,role:e},t=this.generateMockToken(r);return this.currentUser.set(r),localStorage.setItem("currentUser",JSON.stringify(r)),localStorage.setItem(s.jwtTokenKey,t),this.router.navigateByUrl("/dashboard"),l(!0)}logout(){if(console.log("\u{1F6AA} Logging out..."),s.enableMockData)return this.clearAuthData(),l(void 0);let e=localStorage.getItem("supabase.auth.token");if(!e)return console.log("No token found, clearing auth data"),this.clearAuthData(),l(void 0);let r=JSON.parse(e);return h(fetch(`${s.supabase.url}/auth/v1/logout`,{method:"POST",headers:{"Content-Type":"application/json",apikey:s.supabase.anonKey,Authorization:`Bearer ${r.access_token}`}}).then(t=>{console.log("\u{1F4E5} Logout response status:",t.status),t.status===204||t.ok?console.log("\u2705 Successfully logged out from Supabase"):console.warn("\u26A0\uFE0F Logout returned non-success status, but will clear local data anyway")}).catch(t=>{console.error("\u274C Logout error:",t)})).pipe(f(()=>this.clearAuthData()),b(()=>{}),d(()=>(this.clearAuthData(),l(void 0))))}clearAuthData(){console.log("\u{1F9F9} Clearing auth data"),this.currentUser.set(null),localStorage.removeItem("currentUser"),localStorage.removeItem("supabase.auth.token"),console.log("\u27A1\uFE0F Redirecting to login"),this.router.navigateByUrl("/login")}generateMockToken(e){let r=btoa(JSON.stringify({alg:"HS256",typ:"JWT"})),t=btoa(JSON.stringify({sub:e.id,email:e.email,role:e.role,iat:Math.floor(Date.now()/1e3),exp:Math.floor(Date.now()/1e3)+1440*60})),o=btoa("mock-signature");return`${r}.${t}.${o}`}isAdmin(){return this.currentUser()?.role==="admin"}async isAuthenticated(){if(s.enableMockData)return!!this.currentUser();let{data:e}=await this.supabaseService.auth.getSession();return!!e.session}};c.\u0275fac=function(r){return new(r||c)},c.\u0275prov=k({token:c,factory:c.\u0275fac,providedIn:"root"});var I=c;export{I as a};
