import{e as v}from"./chunk-C6JBQQCA.js";import{Ha as k,J as d,N as b,S as g,ea as S,hc as y,i as p,ic as a,j as i,jc as U,o as f,w as h}from"./chunk-4ZOEYAJO.js";var l=class l{constructor(){this.apiService=g(y);this.supabaseService=g(U);this.router=g(v);this.ngZone=g(k);this.currentUser=S(null);this.initializeAuth(),this.setupAuthListener()}async initializeAuth(){if(a.enableMockData){let e=localStorage.getItem("currentUser");if(e)try{this.currentUser.set(JSON.parse(e))}catch(r){console.error("Error parsing stored user:",r),this.clearAuthData()}return}try{let{data:{session:e}}=await this.supabaseService.auth.getSession();e?.user&&await this.loadUserProfile(e.user.id)}catch(e){console.error("Error initializing auth:",e)}}setupAuthListener(){a.enableMockData||this.supabaseService.auth.onAuthStateChange(async(e,r)=>{e==="SIGNED_IN"&&r?.user?await this.loadUserProfile(r.user.id):e==="SIGNED_OUT"&&this.currentUser.set(null)})}async loadUserProfile(e){try{let{data:r,error:t}=await this.supabaseService.db.from("users").select("*").eq("id",e).single();if(t)throw t;if(r){let o={id:r.id,email:r.email,role:r.role};this.currentUser.set(o),localStorage.setItem("currentUser",JSON.stringify(o))}}catch(r){console.error("Error loading user profile:",r)}}loginWithEmail(e,r){if(console.log("loginWithEmail() called with email:",e),console.log("enableMockData:",a.enableMockData),a.enableMockData){console.log("Using mock login");let t=e.includes("admin")?"admin":"technician";return this.mockLogin(t)}return this.performSupabaseLogin(e,r)}login(e,r){if(console.log("login() called with role:",e),console.log("enableMockData:",a.enableMockData),a.enableMockData)return console.log("Using mock login"),this.mockLogin(e);let t=`${e}@example.com`,o=r||"password123";return this.performSupabaseLogin(t,o)}performSupabaseLogin(e,r){console.log("Attempting Supabase login with email:",e);let t=fetch(`${a.supabase.url}/auth/v1/token?grant_type=password`,{method:"POST",headers:{"Content-Type":"application/json",apikey:a.supabase.anonKey},body:JSON.stringify({email:e,password:r})}).then(async o=>{console.log("Supabase API response:",o.status);let s=await o.json();if(!o.ok)throw new Error(s.error_description||s.msg||"Login failed");console.log("Login successful, user:",s.user),console.log("Storing tokens in localStorage..."),localStorage.setItem("supabase.auth.token",JSON.stringify({access_token:s.access_token,refresh_token:s.refresh_token,expires_at:s.expires_at})),console.log("Loading user profile for ID:",s.user.id);try{let c=await(await fetch(`${a.supabase.url}/rest/v1/users?id=eq.${s.user.id}`,{headers:{apikey:a.supabase.anonKey,Authorization:`Bearer ${s.access_token}`}})).json();if(console.log("Profile response:",c),c&&c.length>0){let n=c[0],u={id:n.id,email:n.email,role:n.role};this.currentUser.set(u),localStorage.setItem("currentUser",JSON.stringify(u)),console.log("User profile loaded:",u)}else{console.warn("No profile found, using data from auth user_metadata");let n=s.user.user_metadata?.role||s.user.raw_user_meta_data?.role||"technician",u={id:s.user.id,email:s.user.email,role:n};this.currentUser.set(u),localStorage.setItem("currentUser",JSON.stringify(u))}}catch(m){console.error("Error loading user profile:",m);let c=s.user.user_metadata?.role||s.user.raw_user_meta_data?.role||"technician",n={id:s.user.id,email:s.user.email,role:c};this.currentUser.set(n),localStorage.setItem("currentUser",JSON.stringify(n))}return!0}).catch(o=>{throw console.error("Login error:",o),o});return p(t).pipe(d(o=>{o&&(console.log("Login successful, navigating to dashboard..."),console.log("Current user:",this.currentUser()),this.ngZone.run(()=>{this.router.navigate(["/dashboard"]).then(()=>{console.log("Navigation completed")})}))}),h(o=>(console.error("Login catchError:",o),i(!1))))}signUp(e,r,t){return a.enableMockData?i(!1):p(this.supabaseService.auth.signUp({email:e,password:r})).pipe(d(async({data:o,error:s})=>{if(s)throw s;o.user&&(await this.supabaseService.db.from("users").insert({id:o.user.id,email:o.user.email,role:t}),await this.loadUserProfile(o.user.id))}),f(({error:o})=>!o),h(o=>(console.error("Sign up error:",o),i(!1))))}mockLogin(e){let r={id:e==="admin"?"1":"2",email:`${e}@example.com`,role:e},t=this.generateMockToken(r);return this.currentUser.set(r),localStorage.setItem("currentUser",JSON.stringify(r)),localStorage.setItem(a.jwtTokenKey,t),this.router.navigateByUrl("/dashboard"),i(!0)}logout(){if(console.log("\u{1F6AA} Logging out..."),a.enableMockData)return this.clearAuthData(),i(void 0);let e=localStorage.getItem("supabase.auth.token");if(!e)return console.log("No token found, clearing auth data"),this.clearAuthData(),i(void 0);let r=JSON.parse(e);return p(fetch(`${a.supabase.url}/auth/v1/logout`,{method:"POST",headers:{"Content-Type":"application/json",apikey:a.supabase.anonKey,Authorization:`Bearer ${r.access_token}`}}).then(t=>{console.log("\u{1F4E5} Logout response status:",t.status),t.status===204||t.ok?console.log("\u2705 Successfully logged out from Supabase"):console.warn("\u26A0\uFE0F Logout returned non-success status, but will clear local data anyway")}).catch(t=>{console.error("\u274C Logout error:",t)})).pipe(d(()=>this.clearAuthData()),f(()=>{}),h(()=>(this.clearAuthData(),i(void 0))))}clearAuthData(){console.log("\u{1F9F9} Clearing auth data"),this.currentUser.set(null),localStorage.removeItem("currentUser"),localStorage.removeItem("supabase.auth.token"),console.log("\u27A1\uFE0F Redirecting to login"),this.router.navigateByUrl("/login")}generateMockToken(e){let r=btoa(JSON.stringify({alg:"HS256",typ:"JWT"})),t=btoa(JSON.stringify({sub:e.id,email:e.email,role:e.role,iat:Math.floor(Date.now()/1e3),exp:Math.floor(Date.now()/1e3)+1440*60})),o=btoa("mock-signature");return`${r}.${t}.${o}`}isAdmin(){return this.currentUser()?.role==="admin"}async isAuthenticated(){if(a.enableMockData)return!!this.currentUser();let{data:e}=await this.supabaseService.auth.getSession();return!!e.session}};l.\u0275fac=function(r){return new(r||l)},l.\u0275prov=b({token:l,factory:l.\u0275fac,providedIn:"root"});var w=l;export{w as a};
